# SAM2 (Segment Anything Model 2) Dockerfile
# Base image with PyTorch and CUDA support (using runtime instead of devel for smaller size)
FROM pytorch/pytorch:2.3.1-cuda11.8-cudnn8-runtime

# Set environment variables
ENV DEBIAN_FRONTEND=noninteractive
ENV PYTHONUNBUFFERED=1

# Create personal directory structure
RUN mkdir -p /develop/code \
    /develop/data \
    /develop/results \
    /develop/build

# Set working directory
WORKDIR /develop/code

# Install system dependencies
RUN apt-get update && apt-get install -y --no-install-recommends \
    git \
    wget \
    libgl1-mesa-glx \
    libglib2.0-0 \
    libsm6 \
    libxext6 \
    libxrender-dev \
    libgomp1 \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*

# Upgrade pip and install wheel
RUN pip install --upgrade pip setuptools wheel

# Clone and install SAM2
RUN git clone https://github.com/facebookresearch/segment-anything-2.git /develop/code/sam2 && \
    cd /develop/code/sam2 && \
    pip install -e . && \
    # Clean up git history to reduce size
    rm -rf .git

# Install additional project dependencies
RUN pip install --no-cache-dir \
    matplotlib>=3.10.7 \
    numpy>=2.3.5 \
    opencv-python>=4.11.0.86 \
    jupyterlab \
    notebook \
    ipykernel \
    pillow

# Create directory for model checkpoints (will be mounted from PVC)
RUN mkdir -p /develop/build/checkpoints

# Clean up pip cache to reduce image size
RUN pip cache purge

# Set working directory to code
WORKDIR /develop/code

# Default command
CMD ["/bin/bash"]
